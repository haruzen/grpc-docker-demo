- name: Provision EC2 for microservices
  hosts: webserver
  become: true
  vars:
    docker_username: "{{ lookup('env', 'DOCKER_USERNAME') }}"
    docker_password: "{{ lookup('env', 'DOCKER_PASSWORD') }}"
    node_image: "{{ docker_username }}/node-rest:release_v1.0"
    python_image: "{{ docker_username }}/python-grpc:release_v1.0"
  tasks:
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: true

    - name: Login to Docker Hub
      shell: echo "{{ docker_password }}" | docker login -u "{{ docker_username }}" --password-stdin

    - name: Pull Node.js REST image
      docker_image:
        name: "{{ node_image }}"
        source: pull

    - name: Pull Python gRPC image
      docker_image:
        name: "{{ python_image }}"
        source: pull

    - name: Run Node.js REST container
      docker_container:
        name: node-rest
        image: "{{ node_image }}"
        state: started
        restart_policy: always
        ports:
          - "80:3000"
        env:
          GRPC_HOST: "python-grpc"
          GRPC_PORT: "50051"

    - name: Run Python gRPC container
      docker_container:
        name: python-grpc
        image: "{{ python_image }}"
        state: started
        restart_policy: always
        ports:
          - "50051:50051"
